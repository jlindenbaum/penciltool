<!DOCTYPE html>
<html>
<head>
    <title>SaskTel Canvas Drawing Example</title>
</head>
<body>
    
    <!--><canvas id="drawing" width="700" height="300" style="border: 1px solid">
    </canvas>-->
    
    <div id="pencil-tool">Loading...</div>
    
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script type="text/javascript">
    $(document).ready(function() {
        
        $('#pencil-tool').pencilTool();
        
    });
    
    (function($) {
        
        var settings = $.extend({
            'lineWidth': 4,
            'strokeStyle': '#F00'
        });
        
        var methods = {
            init: function (options) {
                var tool = this;
                if (options !== undefined) {
                    settings = $.extend(settings, options);
                }
                console.log(tool);
            },
            canvasEvent: function(event) {
                console.log('event!!');
            }
        };
        
        $.fn.pencilTool = function(method) {
            if (methods[method]) {
                return methods[method].apply(this, Array.prototype.slice.call(arguments, 1));
            } else if (typeof method === 'object' || !method) {
                return methods.init.apply(this, arguments);
            } else {
                $.error('Method ' + method + ' does not exist in pencilTool');
            }
        };
    })(jQuery);
    
    var pencilOptions = {
        'lineWidth': 1,
        'strokeStyle': '#000'
    }
    //var tool = new PencilTool('drawing', pencilOptions);
    
    function PencilTool(canvasID, passedOptions) {
        var tool = this;
        this.options = {
            'lineWidth': 4,
            'strokeStyle': '#F00'
        };
        
        if (passedOptions !== undefined) {
            for (var key in passedOptions) {
                this.options[key] = passedOptions[key];
            }
        }
        
        this.started = false;
        this.body = document.body;
        this.canvas = document.getElementById(canvasID);
        this.canvasContext = this.canvas.getContext('2d');
        this.canvasContext.lineWidth = this.options.lineWidth;
        this.canvasContext.fillStyle = this.options.fillStyle;
        this.canvasContext.strokeStyle = this.options.strokeStyle;
        
        this.getImageData = function () {
            return tool.canvas.toDataURL();
        }
        
        this.bodyTouchListener = function (event) {
            event.preventDefault();
        }
        
        this.touchstart = function (event) {
            tool.mousedown(event);
        }
        this.mousedown = function (event) {
            //console.log('mouse down');
            
            // stop elastic scrolling
            tool.body.addEventListener('touchmove', tool.bodyTouchListener, false);
            
            // start drawing
            tool.canvasContext.beginPath();
            tool.canvasContext.moveTo(event._x, event._y);
            tool.started = true;
        };
        
        this.touchmove = function (event) {
            console.log(event._x + ' -- ' + event._y);
            if (event._x > 0 && event._y > 0) {
                tool.mousemove(event);
            }
        }
        this.mousemove = function (event) {
            //console.log('mouse move');
            if (tool.started) {
                tool.canvasContext.lineTo(event._x, event._y);
                tool.canvasContext.stroke();
            }
        };
        
        this.touchend = function (event) {
            tool.mouseup(event);
        }
        this.mouseup = function (event) {
            //console.log('mouse up');
            if (tool.started) {
                tool.body.removeEventListener('touchmove', tool.bodyTouchListener, false);
                
                tool.started = false;
            }
        };
        
        this.canvasEvent = function (event) {
            console.log(event);
            
            var targetElement = event.target;
            var x = y = 0;
            
            while (targetElement && !isNaN(targetElement.offsetLeft) && !isNaN(targetElement.offsetTop)) {
                x += targetElement.offsetLeft - targetElement.scrollLeft;
                y += targetElement.offsetTop - targetElement.scrollTop;
                targetElement = targetElement.offsetParent;
            }
            
            if (event.clientX && event.clientY) {
                event._x = event.clientX - x;
                event._y = event.clientY - y;
            }
            else {
                event._x = event.pageX - x;
                event._y = event.pageY - y;
            }
            
            var eventCall = tool[event.type];
            if (eventCall) {
                eventCall(event);
            }
        };
        
        this.canvas.addEventListener('mousemove', this.canvasEvent, false);
        this.canvas.addEventListener('mousedown', this.canvasEvent, false);
        this.canvas.addEventListener('mouseup', this.canvasEvent, false);
        this.canvas.addEventListener('touchmove', this.canvasEvent, false);
        this.canvas.addEventListener('touchstart', this.canvasEvent, false);
        this.canvas.addEventListener('touchend', this.canvasEvent, false);
    }
    </script>
</body>
</html>